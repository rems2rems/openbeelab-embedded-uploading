// Generated by CoffeeScript 1.9.2
(function() {
  var config, configDb, configDbOptions, dataDb, dataDbOptions, dbDriver, insert_measure;

  dbDriver = require('../../openbeelab-db-util/javascript/dbUtil');

  config = require('./config');

  configDbOptions = {
    host: config.host,
    protocol: config.protocol,
    port: config.port,
    auth: {
      username: config.auth.username,
      password: config.auth.password
    },
    name: config.name + "_config"
  };

  configDb = dbDriver.database(configDbOptions);

  dataDbOptions = {
    host: config.host,
    protocol: config.protocol,
    port: config.port,
    auth: {
      username: config.auth.username,
      password: config.auth.password
    },
    name: config.name + "_data"
  };

  dataDb = dbDriver.database(dataDbOptions);

  insert_measure = require('./insert_measure');

  configDb.get(config.stand_id).then(function(stand) {
    var device, i, len, measure, ref, results, sensor, specificProcess, value;
    device = require('./devices/' + stand.device);
    ref = stand.sensors;
    results = [];
    for (i = 0, len = ref.length; i < len; i++) {
      sensor = ref[i];
      if (!sensor.active) {
        continue;
      }
      sensor.device = device;
      if (device[sensor.process] != null) {
        measure = device[sensor.process];
      } else {
        specificProcess = require('./' + sensor.process);
        measure = specificProcess(sensor, device)[sensor.action];
      }
      value = measure(sensor, device);
      console.log("measure:" + value);
      measure = {
        timestamp: new Date(),
        location_id: stand.location._id,
        beehouse_id: stand.beehouse._id,
        stand_id: stand._id,
        type: 'measure',
        name: sensor.name,
        raw_value: value,
        value: (value - sensor.bias) * sensor.gain,
        unit: sensor.unit
      };
      results.push(dataDb.save(measure).then(function(result) {
        console.log("measure uploaded to db " + dataDbOptions.name);
        console.log("measure id:" + result._id);
        return dataDb.save({
          _id: "_design/updates/_update/time/" + result._id
        });
      }).then(function() {
        return console.log("added server timestamp");
      }));
    }
    return results;
  })["catch"](function(err) {
    return console.log(err);
  });

}).call(this);
