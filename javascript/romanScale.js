// Generated by CoffeeScript 1.9.2
(function() {
  var Pin, StepMotor, _searchEquilibrium, sleep;

  require('../../openbeelab-util/javascript/numberUtils').install();

  Pin = require('./pin');

  StepMotor = require('./stepMotor');

  sleep = require('../../openbeelab-util/javascript/timeUtils').sleep;

  _searchEquilibrium = function(motor, photoDiode1, photoDiode2, pid) {
    var deltaLight, light1, light2, nbSteps;
    console.log("searching equilibrium...");
    light1 = photoDiode1.getValue();
    light2 = photoDiode2.getValue();
    console.log("light1=" + light1);
    console.log("light2=" + light2);
    deltaLight = light1 - light2;
    nbSteps = 0;
    if (light1 > light2) {
      while (!(light1 - light2 < 10)) {
        motor.forward();
        nbSteps += 1;
        light1 = photoDiode1.getValue();
        light2 = photoDiode2.getValue();
      }
    }
    if (light2 > light1) {
      while (!(light1 - light2 > 100)) {
        motor.backward();
        nbSteps -= 1;
        light1 = photoDiode1.getValue();
        light2 = photoDiode2.getValue();
      }
      while (!(light1 - light2 < 10)) {
        motor.forward();
        nbSteps += 1;
        light1 = photoDiode1.getValue();
        light2 = photoDiode2.getValue();
      }
    }
    if (light2 - light1 < 10) {

    }
    return nbSteps;
  };

  module.exports = function(sensor, device) {
    var motor, photoDiode1, photoDiode2;
    motor = StepMotor(device, sensor.motor);
    photoDiode1 = Pin.buildAdc(device, sensor.photoDiode1);
    photoDiode2 = Pin.buildAdc(device, sensor.photoDiode2);
    return {
      searchEquilibrium: function() {
        var infos;
        motor.switchOn();
        infos = _searchEquilibrium(motor, photoDiode1, photoDiode2);
        motor.switchOff();
        return infos;
      }
    };
  };

}).call(this);
